import tensorflow as tf
from abc import abstractmethod
LAYER_IDS = {}

def get_layer_id(layer_name=''):
    if layer_name not in LAYER_IDS:
        LAYER_IDS[layer_name] = 0
        return 0
    else:
        LAYER_IDS[layer_name] += 1
        return LAYER_IDS[layer_name]


class Layer(object):
    def __init__(self, name):
        if not name:
            layer = self.__class__.__name__.lower()
            name = layer + '_' + str(get_layer_id(layer))
        self.name = name
        self.vars = []

    def __call__(self, inputs):
        outputs = self._call(inputs)
        return outputs

    @abstractmethod
    def _call(self, inputs):
        pass


class Dense(Layer):
    def __init__(self, input_dim, output_dim, dropout=0.0, act=tf.nn.relu, name=None):
        super(Dense, self).__init__(name)
        self.input_dim = input_dim
        self.output_dim = output_dim
        self.dropout = dropout
        self.act = act

        with tf.variable_scope(self.name):
            self.weight = tf.get_variable(
                name='weight',
                shape=(input_dim, output_dim),
                initializer=tf.truncated_normal_initializer(mean=0.0, stddev=0.01),
                dtype=tf.float32)
            self.bias = tf.get_variable(
                name='bias',
                shape=output_dim,
                initializer=tf.truncated_normal_initializer(mean=0.0, stddev=0.01),
                dtype=tf.float32)
        self.vars = [self.weight]

    def _call(self, inputs):
        x = tf.nn.dropout(inputs, 1-self.dropout)
        output = tf.matmul(x, self.weight) + self.bias
        return self.act(output)
